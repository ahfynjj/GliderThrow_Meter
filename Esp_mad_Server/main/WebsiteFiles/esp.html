<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <title>舵面量角器 · ESP MAD 控制台</title>
                <link rel="stylesheet" href="bootstrap.min.css" />
                <style>
                    :root {
                        color-scheme: light;
                    }

                    body {
                        background: #f5f6fa;
                        color: #2f3542;
                        font-family: "Microsoft YaHei", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
                        font-size: 16px;
                        line-height: 1.5;
                    }

                    .jumbotron {
                        background: linear-gradient(135deg, #6159e6 0%, #a26afc 100%);
                        color: #fff;
                        border-radius: 20px;
                        padding: 32px 28px;
                        margin-bottom: 24px;
                    }

                    .jumbotron h1 {
                        font-size: 42px;
                        margin-bottom: 8px;
                    }

                    .jumbotron span {
                        font-size: 20px;
                        opacity: 0.9;
                    }

                    .section-heading {
                        font-size: 26px;
                        font-weight: 600;
                        margin-bottom: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .section-heading small {
                        font-size: 16px;
                        color: #7b809a;
                        font-weight: 400;
                    }

                    .info-section {
                        margin-bottom: 24px;
                    }

                    .metric-card {
                        background: #fff;
                        border-radius: 18px;
                        padding: 18px 20px;
                        box-shadow: 0 10px 24px rgba(15, 22, 56, 0.08);
                        border: 1px solid rgba(102, 119, 255, 0.07);
                        transition: transform 0.2s ease, box-shadow 0.2s ease;
                        height: 100%;
                    }

                    .metric-card:hover {
                        transform: translateY(-4px);
                        box-shadow: 0 20px 40px rgba(15, 22, 56, 0.12);
                    }

                    .metric-title {
                        font-size: 18px;
                        font-weight: 500;
                        margin-bottom: 6px;
                        color: #7b809a;
                    }

                    .metric-value {
                        font-size: 28px;
                        font-weight: 600;
                        margin: 0;
                        color: #2f3542;
                        line-height: 1.3;
                    }

                    .panel-pink {
                        border-top: 4px solid #ff70b8;
                    }

                    .panel-blue {
                        border-top: 4px solid #3c9bff;
                    }

                    .panel-purple {
                        border-top: 4px solid #8c7bff;
                    }

                    .panel-green {
                        border-top: 4px solid #2ed573;
                    }

                    .section-button {
                        background: linear-gradient(120deg, #8f8e8e 0%, #706464 100%);
                        border-radius: 12px;
                        padding: 12px 20px;
                        border: none;
                        color: #fff;
                        font-size: 20px;
                        font-weight: 600;
                        width: 100%;
                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
                    }

                    .settings-input,
                    .settings-button {
                        border-radius: 12px;
                        font-size: 20px;
                        padding: 14px;
                        margin-bottom: 12px;
                    }

                    .settings-button {
                        background-color: #33ff00;
                        border: none;
                        color: #1c1c1c;
                        font-weight: 600;
                        transition: transform 0.15s ease;
                    }

                    .settings-button:active {
                        transform: scale(0.98);
                    }

                    .status-pill {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        border-radius: 999px;
                        padding: 6px 14px;
                        font-size: 16px;
                        color: #fff;
                        background: #1dd1a1;
                    }

                    .status-pill i {
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.9);
                        display: inline-block;
                    }

                    @media (max-width: 1200px) {
                        .jumbotron h1 {
                            font-size: 34px;
                        }

                        .jumbotron span {
                            font-size: 18px;
                        }

                        .metric-value {
                            font-size: 24px;
                        }
                    }

                    @media (max-width: 768px) {
                        .jumbotron {
                            padding: 24px 18px;
                        }

                        .jumbotron h1 {
                            font-size: 28px;
                        }

                        .jumbotron span {
                            font-size: 16px;
                        }

                        .section-heading {
                            flex-direction: column;
                            align-items: flex-start;
                            font-size: 22px;
                        }

                        .metric-value {
                            font-size: 22px;
                        }

                        .section-button {
                            font-size: 18px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="container py-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="jumbotron text-center shadow-sm">
                                <h1>舵面量角器</h1>
                                <span>最简单的滑翔机调参方式</span>
                            </div>
                        </div>
                    </div>

                    <section class="info-section">
                        <h2 class="section-heading">传感器校准 <small>最常用操作</small></h2>
                        <div class="metric-card panel-green d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                            <div>
                                <p class="metric-title mb-1">一键清除最大 / 最小记录值</p>
                                <p class="metric-value" style="font-size:24px;">重新标定两路传感器，立即归零显示</p>
                            </div>
                            <div class="w-100" style="max-width:280px;">
                                <button type="button" class="section-button" id="resetSubmit" name="resetSubmit">重新标定两路传感器</button>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h2 class="section-heading">目标角度对准</h2>
                        <div class="row g-3 align-items-stretch">
                            <div class="col-lg-8 col-md-12">
                                <div class="metric-card panel-purple h-100">
                                    <p class="metric-title">设定目标角度（°）</p>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <input class="settings-input form-control flex-grow-1" type="number" step="0.1" id="targetAngleInput" name="targetAngleInput" placeholder="例如 15.0" />
                                        <button class="settings-button" id="targetAngleSubmit" name="targetAngleSubmit" style="min-width:140px;">保存目标角度</button>
                                    </div>
                                    <p class="metric-value mt-2">当前目标：<span id="targetAngleDisplay">--</span> °</p>
                                    <p class="metric-title">与主站角度差：<span id="targetDiffDisplay">--</span> °</p>
                                    <p class="text-muted mb-0">LED 提示：≤0.1° 常亮｜0.1-0.5° 10Hz｜0.5-1° 5Hz｜&gt;1° 1Hz</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <h2 class="section-heading">主站（Server）</h2>
                            <span class="status-pill"><i></i>实时刷新</span>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6 col-md-12">
                                <div class="metric-card panel-pink h-100">
                                    <p class="metric-title">当前行程 / 角度</p>
                                    <p class="metric-value">行程：<span id="travel1">--</span> mm ｜ 角度：<span id="angle1">--</span> 度</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <h2 class="section-heading">Client</h2>
                            <span class="status-pill" style="background:#00cec9"><i></i>蓝牙链路</span>
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6 col-md-12">
                                <div class="metric-card panel-blue h-100">
                                    <p class="metric-title">当前行程 / 角度</p>
                                    <p class="metric-value">行程：<span id="travel2">--</span> mm ｜ 角度：<span id="angle2">--</span> 度</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h2 class="section-heading">快速操作</h2>
                        <div class="row g-3 align-items-stretch">
                            <div class="col-lg-8 col-md-12">
                                <div class="metric-card panel-green h-100">
                                    <p class="metric-title">舵弦长度（Chord Control Surface）</p>
                                    <input class="settings-input form-control" type="number" min="1" step="1" id="chordValue" name="chordValue" value="50" />
                                    <button class="settings-button" id="chordSubmit" name="chordSubmit">保存舵弦长度</button>
                                    <p class="text-muted mb-0">用于计算角度，建议在修改传感器安装距离后立即更新。</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h2 class="section-heading">系统信息</h2>
                        <div class="row g-3">
                            <div class="col-lg-6 col-md-12">
                                <div class="metric-card panel-pink h-100">
                                    <p class="metric-title">传感器 1 电压</p>
                                    <p class="metric-value"><span id="voltage1">--</span> V</p>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="metric-card panel-blue h-100">
                                    <p class="metric-title">传感器 2 电压</p>
                                    <p class="metric-value"><span id="voltage2">--</span> V</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <script src="jquery-3.3.1.min.js"></script>
                <script src="bootstrap.min.js"></script>
                <script>
                    $(function () {
                        const FALLBACK_SYMBOL = "--";
                        const POLL_INTERVAL_MS = 200;
                        const REQUEST_TIMEOUT_MS = 800;
                        const TARGET_ENDPOINT = "/target_angle";
                        let pollTimer = null;
                        let pendingRequest = null;

                        function setDisplay(selector, value, fallback) {
                            const text = value === undefined || value === null || value === "" ? fallback : value;
                            $(selector).text(text);
                        }

                        function renderFallback() {
                            const targets = [
                                "#travel1", "#travel2", "#angle1", "#angle2",
                                "#voltage1", "#voltage2",
                                "#targetAngleDisplay", "#targetDiffDisplay"
                            ];
                            targets.forEach((selector) => $(selector).text(FALLBACK_SYMBOL));
                            $("#targetAngleInput").val("");
                        }

                        function resetCurrentReadingsToZero() {
                            const zeroTargets = ["#travel1", "#travel2", "#angle1", "#angle2", "#targetDiffDisplay"];
                            zeroTargets.forEach((selector) => $(selector).text("0"));
                        }

                        function scheduleNextPoll(delay = POLL_INTERVAL_MS) {
                            clearTimeout(pollTimer);
                            pollTimer = setTimeout(requestData, delay);
                        }

                        function requestData() {
                            pendingRequest = $.ajax({
                                url: "/sensors",
                                cache: false,
                                dataType: "json",
                                timeout: REQUEST_TIMEOUT_MS
                            })
                                .done(function (obj) {
                                    if (!obj) {
                                        renderFallback();
                                        return;
                                    }

                                    setDisplay("#travel1", obj.travel1, FALLBACK_SYMBOL);
                                    setDisplay("#travel2", obj.travel2, FALLBACK_SYMBOL);
                                    setDisplay("#angle1", obj.angle1, FALLBACK_SYMBOL);
                                    setDisplay("#angle2", obj.angle2, FALLBACK_SYMBOL);

                                    setDisplay("#voltage1", obj.voltage1, FALLBACK_SYMBOL);
                                    setDisplay("#voltage2", obj.voltage2, FALLBACK_SYMBOL);

                                    if (obj.targetEnabled) {
                                        if (typeof obj.targetAngle === "number") {
                                            setDisplay("#targetAngleDisplay", obj.targetAngle.toFixed(1), FALLBACK_SYMBOL);
                                            $("#targetAngleInput").attr("placeholder", obj.targetAngle.toFixed(1));
                                        } else {
                                            setDisplay("#targetAngleDisplay", FALLBACK_SYMBOL, FALLBACK_SYMBOL);
                                        }

                                        if (typeof obj.targetDiff === "number") {
                                            setDisplay("#targetDiffDisplay", obj.targetDiff.toFixed(2), FALLBACK_SYMBOL);
                                        } else {
                                            setDisplay("#targetDiffDisplay", FALLBACK_SYMBOL, FALLBACK_SYMBOL);
                                        }
                                    } else {
                                        setDisplay("#targetAngleDisplay", FALLBACK_SYMBOL, FALLBACK_SYMBOL);
                                        setDisplay("#targetDiffDisplay", FALLBACK_SYMBOL, FALLBACK_SYMBOL);
                                        $("#targetAngleInput").attr("placeholder", "例如 15.0");
                                    }
                                })
                                .fail(function (_xhr, status) {
                                    console.warn("获取数据时出现问题：", status);
                                    renderFallback();
                                })
                                .always(function () {
                                    pendingRequest = null;
                                    scheduleNextPoll();
                                });
                        }

                        requestData();

                        $("#chordSubmit").on("click", function () {
                            const chordValue = $("#chordValue").val();
                            $.post("/chord", { chordValue })
                                .done(function (data) {
                                    alert(data || "参数已发送");
                                })
                                .fail(function () {
                                    alert("保存舵弦长度时出现问题，请稍后再试。");
                                });
                        });

                        $("#resetSubmit").on("click", function () {
                            $.post("/reset")
                                .done(function () {
                                    alert("已重新标定，两路传感器读数已归零");
                                    resetCurrentReadingsToZero();
                                })
                                .fail(function () {
                                    alert("发送重置指令失败，请检查网络连接。");
                                });
                        });

                        $("#targetAngleSubmit").on("click", function () {
                            const rawValue = $("#targetAngleInput").val();
                            const parsedValue = parseFloat(rawValue);

                            if (Number.isNaN(parsedValue)) {
                                alert("请输入有效的目标角度（数字）");
                                return;
                            }

                            $.ajax({
                                url: TARGET_ENDPOINT,
                                method: "POST",
                                contentType: "application/json",
                                data: JSON.stringify({ targetAngle: parsedValue })
                            })
                                .done(function () {
                                    alert("目标角度已更新，LED 已进入指示模式");
                                })
                                .fail(function () {
                                    alert("目标角度更新失败，请重试");
                                });
                        });
                    });
                </script>
            </body>
            </html>